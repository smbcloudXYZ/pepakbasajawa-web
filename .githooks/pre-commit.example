#!/bin/sh
#
# Pre-commit hook to prevent accidental credential leaks
#
# To enable this hook:
#   1. Copy this file: cp .githooks/pre-commit.example .git/hooks/pre-commit
#   2. Make it executable: chmod +x .git/hooks/pre-commit
#
# Or configure git to use this hooks directory:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit.example
#   mv .githooks/pre-commit.example .githooks/pre-commit

echo "ğŸ”’ Running security checks..."

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Flag to track if we found issues
FOUND_ISSUES=0

# Check 1: Prevent committing .env files
echo "Checking for .env files..."
if git diff --cached --name-only | grep -E "^\.env$|^\.env\..*$" > /dev/null; then
    echo "${RED}âŒ ERROR: Attempting to commit .env file!${NC}"
    echo "${YELLOW}   .env files should never be committed to the repository.${NC}"
    echo "${YELLOW}   Add them to .gitignore instead.${NC}"
    FOUND_ISSUES=1
fi

# Check 2: Look for GitHub token patterns
echo "Checking for GitHub tokens..."
if git diff --cached | grep -E "ghp_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}" > /dev/null; then
    echo "${RED}âŒ ERROR: Possible GitHub token detected in commit!${NC}"
    echo "${YELLOW}   Found pattern matching GitHub personal access token.${NC}"
    echo "${YELLOW}   Make sure you're not committing actual tokens.${NC}"
    echo "${YELLOW}   Use placeholders like 'ghp_your_token_here' instead.${NC}"
    FOUND_ISSUES=1
fi

# Check 3: Look for common secret patterns
echo "Checking for other credentials..."
if git diff --cached | grep -E "sk_live_[a-zA-Z0-9]{24,}|pk_live_[a-zA-Z0-9]{24,}|sk_test_[a-zA-Z0-9]{24,}" > /dev/null; then
    echo "${RED}âŒ ERROR: Possible API key detected in commit!${NC}"
    echo "${YELLOW}   Found pattern matching Stripe or other API keys.${NC}"
    echo "${YELLOW}   Never commit actual API keys to the repository.${NC}"
    FOUND_ISSUES=1
fi

# Check 4: Look for AWS credentials
echo "Checking for AWS credentials..."
if git diff --cached | grep -E "AKIA[0-9A-Z]{16}|aws_access_key_id|aws_secret_access_key" > /dev/null; then
    echo "${RED}âŒ ERROR: Possible AWS credentials detected!${NC}"
    echo "${YELLOW}   Never commit AWS credentials to the repository.${NC}"
    FOUND_ISSUES=1
fi

# Check 5: Look for private keys
echo "Checking for private keys..."
if git diff --cached | grep -E "BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY" > /dev/null; then
    echo "${RED}âŒ ERROR: Private key detected in commit!${NC}"
    echo "${YELLOW}   Never commit private keys to the repository.${NC}"
    FOUND_ISSUES=1
fi

# Check 6: Look for hardcoded passwords
echo "Checking for hardcoded passwords..."
if git diff --cached | grep -E "password\s*=\s*['\"][^'\"]{8,}['\"]|PASSWORD\s*=\s*['\"][^'\"]{8,}['\"]" > /dev/null; then
    echo "${YELLOW}âš ï¸  WARNING: Possible hardcoded password detected!${NC}"
    echo "${YELLOW}   Review your commit to ensure no actual passwords are included.${NC}"
    echo "${YELLOW}   Use environment variables for sensitive data.${NC}"
    # Don't block commit, just warn
fi

# Check 7: Verify .gitignore includes .env
echo "Verifying .gitignore configuration..."
if [ -f .gitignore ]; then
    if ! grep -q "^\.env" .gitignore; then
        echo "${YELLOW}âš ï¸  WARNING: .env not found in .gitignore${NC}"
        echo "${YELLOW}   Consider adding .env files to .gitignore${NC}"
    fi
else
    echo "${YELLOW}âš ï¸  WARNING: No .gitignore file found${NC}"
fi

# Final result
if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${RED}âŒ COMMIT BLOCKED: Security issues detected!${NC}"
    echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "${YELLOW}What to do:${NC}"
    echo "  1. Remove sensitive data from your staged files"
    echo "  2. Use environment variables instead: import.meta.env.GITHUB_TOKEN"
    echo "  3. Use placeholders in documentation: ghp_your_token_here"
    echo "  4. Add .env files to .gitignore"
    echo ""
    echo "${YELLOW}To bypass this hook (NOT RECOMMENDED):${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "${GREEN}âœ… All security checks passed!${NC}"
exit 0
